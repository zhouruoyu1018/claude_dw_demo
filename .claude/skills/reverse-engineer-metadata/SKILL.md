# reverse-engineer-metadata

**é€†å‘å·¥ç¨‹ï¼šä»å­˜é‡ SQL è„šæœ¬æå–æŒ‡æ ‡å’Œè¡€ç¼˜**

## ä½¿ç”¨åœºæ™¯

- æ¥æ‰‹é—ç•™æ•°ä»“é¡¹ç›®ï¼Œéœ€è¦è¡¥é½å…ƒæ•°æ®
- å­˜é‡ ETL è„šæœ¬ç¼ºå°‘æ–‡æ¡£ï¼Œéœ€è¦è‡ªåŠ¨åŒ–åˆ†æ
- å…ƒæ•°æ®åº“ç¼ºå¤±ï¼Œéœ€è¦ä»ä»£ç åæ¨è¡€ç¼˜å…³ç³»
- æ•°æ®æ²»ç†æ—¶éœ€è¦ç›˜ç‚¹ç°æœ‰æŒ‡æ ‡èµ„äº§

## æ ¸å¿ƒèƒ½åŠ›

1. **è¡€ç¼˜æå–**
   - è¡¨çº§ä¾èµ–ï¼šç›®æ ‡è¡¨ â† æºè¡¨åˆ—è¡¨ï¼ˆå« JOIN ç±»å‹ï¼‰
   - å­—æ®µçº§æ˜ å°„ï¼šç›®æ ‡å­—æ®µ â† æºè¡¨.æºå­—æ®µ + è½¬æ¢é€»è¾‘

2. **æŒ‡æ ‡è¯†åˆ«**
   - èšåˆæŒ‡æ ‡ï¼šSUM/COUNT/AVG/MAX/MIN
   - æ´¾ç”ŸæŒ‡æ ‡ï¼šCASE WHENã€ç®—æœ¯è¿ç®—ã€çª—å£å‡½æ•°
   - æ¯”ç‡æŒ‡æ ‡ï¼šé™¤æ³•è¿ç®—ã€ROUND åŒ…è£…

3. **æ™ºèƒ½æ¨æ–­**
   - æ ¹æ®å­—æ®µåå’Œè®¡ç®—é€»è¾‘æ¨æ–­ `standard_type`ï¼ˆæ•°å€¼ç±»/æ—¥æœŸç±»/æ–‡æœ¬ç±»/æšä¸¾ç±»/æ—¶é—´ç±»ï¼‰
   - æ ¹æ® SQL ä½ç½®æ¨æ–­ `update_frequency`ï¼ˆåˆ†åŒºå­—æ®µ = dt åˆ™ä¸º `æ¯æ—¥`ï¼‰
   - æ ¹æ®è¡¨å‰ç¼€æ¨æ–­ `business_domain`ï¼ˆdm_loan â†’ è´·æ¬¾åŸŸï¼‰

4. **äº¤äº’ç¡®è®¤**
   - å±•ç¤ºè§£æç»“æœï¼ˆè¡¨çº§è¡€ç¼˜ + å­—æ®µçº§æ˜ å°„ + æŒ‡æ ‡æ¸…å•ï¼‰
   - æ”¯æŒç”¨æˆ·ä¿®æ­£/è¡¥å……ä¿¡æ¯
   - æ‰¹é‡å…¥åº“å‰äºŒæ¬¡ç¡®è®¤

## å·¥ä½œæµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase 1: è„šæœ¬è§£æ  â”‚
â”‚  - è¯»å–å¤šä¸ª SQL æ–‡ä»¶ â”‚
â”‚  - è¯†åˆ«ç›®æ ‡è¡¨        â”‚
â”‚  - æå–æºè¡¨åˆ—è¡¨      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase 2: è¡€ç¼˜åˆ†æ  â”‚
â”‚  - è¡¨çº§ä¾èµ– (JOIN)  â”‚
â”‚  - å­—æ®µçº§æ˜ å°„ (æŠ•å½±) â”‚
â”‚  - è½¬æ¢é€»è¾‘æå–      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase 3: æŒ‡æ ‡è¯†åˆ«  â”‚
â”‚  - èšåˆå‡½æ•°æ£€æµ‹      â”‚
â”‚  - æŒ‡æ ‡å‘½åå¯¹é½      â”‚
â”‚  - ä¸šåŠ¡å£å¾„æ¨æ–­      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase 4: ç”¨æˆ·äº¤äº’  â”‚
â”‚  - å±•ç¤ºåˆ†æç»“æœ      â”‚
â”‚  - æ”¶é›†ç¡®è®¤/ä¿®æ­£     â”‚
â”‚  - ç”Ÿæˆå…¥åº“ Payload  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase 5: æ‰¹é‡å…¥åº“  â”‚
â”‚  - register_lineage â”‚
â”‚  - register_indicatorâ”‚
â”‚  - è¾“å‡ºæˆåŠŸæ—¥å¿—      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## è°ƒç”¨æ–¹å¼

### æ–¹å¼ 1: æŒ‡å®šè„šæœ¬è·¯å¾„

```
/reverse-engineer-metadata sql/hive/etl/dm_loan_daily.sql sql/hive/etl/dm_overdue_summary.sql
```

### æ–¹å¼ 2: æ‰«ææ•´ä¸ªç›®å½•

```
/reverse-engineer-metadata --scan sql/hive/etl/
```

### æ–¹å¼ 3: äº¤äº’å¼é€‰æ‹©

```
/reverse-engineer-metadata
```
ç„¶å Claude ä¼šï¼š
1. åˆ—å‡ºé¡¹ç›®ä¸­æ‰€æœ‰ DML è„šæœ¬
2. è®©ç”¨æˆ·å¤šé€‰éœ€è¦åˆ†æçš„æ–‡ä»¶
3. æ‰§è¡Œåˆ†ææµç¨‹

## å‚æ•°è¯´æ˜

- `--scan <directory>`: æ‰«æç›®å½•ä¸‹æ‰€æœ‰ `.sql` æ–‡ä»¶
- `--dry-run`: ä»…åˆ†æä¸å…¥åº“ï¼Œè¾“å‡º JSON ç»“æœ
- `--skip-indicators`: ä»…æå–è¡€ç¼˜ï¼Œè·³è¿‡æŒ‡æ ‡è¯†åˆ«
- `--skip-lineage`: ä»…æå–æŒ‡æ ‡ï¼Œè·³è¿‡è¡€ç¼˜åˆ†æ

## è¾“å‡ºç¤ºä¾‹

### é˜¶æ®µè¾“å‡º

```markdown
## ğŸ“Š åˆ†æç»“æœ

### 1ï¸âƒ£ è¡¨çº§è¡€ç¼˜

ç›®æ ‡è¡¨: `dm.dmm_sac_loan_prod_daily`

| æºè¡¨                         | JOIN ç±»å‹    | å…³è”æ¡ä»¶                              |
|------------------------------|-------------|--------------------------------------|
| dwd.dwd_loan_detail          | FROM        | -                                    |
| dwd.dwd_product_info         | LEFT JOIN   | a.product_id = b.product_id          |
| dws.dws_overdue_summary      | LEFT JOIN   | a.loan_id = c.loan_id AND c.dt = a.dt|

### 2ï¸âƒ£ å­—æ®µçº§è¡€ç¼˜ï¼ˆéƒ¨åˆ†å±•ç¤ºï¼‰

| ç›®æ ‡å­—æ®µ         | æºè¡¨.æºå­—æ®µ                     | è½¬æ¢é€»è¾‘                      | ç±»å‹     |
|-----------------|--------------------------------|------------------------------|---------|
| dt              | dwd_loan_detail.dt             | DIRECT                       | DIRECT  |
| product_id      | dwd_loan_detail.product_id     | DIRECT                       | DIRECT  |
| td_loan_amt     | dwd_loan_detail.loan_amount    | SUM(loan_amount)             | SUM     |
| td_loan_cnt     | dwd_loan_detail.loan_id        | COUNT(DISTINCT loan_id)      | COUNT   |
| avg_loan_amt    | -                              | td_loan_amt / td_loan_cnt    | CUSTOM  |

### 3ï¸âƒ£ è¯†åˆ«çš„æŒ‡æ ‡

| æŒ‡æ ‡è‹±æ–‡å        | æŒ‡æ ‡ä¸­æ–‡å      | è®¡ç®—é€»è¾‘                       | æ ‡å‡†ç±»å‹  | åˆ†ç±»     |
|------------------|----------------|-------------------------------|---------|---------|
| td_loan_amt      | å½“æ—¥æ”¾æ¬¾é‡‘é¢    | SUM(loan_amount)              | æ•°å€¼ç±»   | åŸå­æŒ‡æ ‡ |
| td_loan_cnt      | å½“æ—¥æ”¾æ¬¾ç¬”æ•°    | COUNT(DISTINCT loan_id)       | æ•°å€¼ç±»   | åŸå­æŒ‡æ ‡ |
| avg_loan_amt     | å¹³å‡å•ç¬”é‡‘é¢    | td_loan_amt / td_loan_cnt     | æ•°å€¼ç±»   | æ´¾ç”ŸæŒ‡æ ‡ |

---

### âœ… è¯·ç¡®è®¤

1. **æŒ‡æ ‡ä¿¡æ¯å‡†ç¡®å—ï¼Ÿ** æ˜¯å¦éœ€è¦ä¿®æ­£ä¸­æ–‡åæˆ–ä¸šåŠ¡å£å¾„ï¼Ÿ
2. **è¡€ç¼˜å…³ç³»å®Œæ•´å—ï¼Ÿ** æ˜¯å¦æœ‰é—æ¼çš„æºè¡¨æˆ–å­—æ®µï¼Ÿ
3. **ç¡®è®¤åæ‰§è¡Œå…¥åº“ï¼Ÿ**

[âœ“ ç¡®è®¤å…¥åº“] [âœ— å–æ¶ˆ] [âœ ä¿®æ”¹æŒ‡æ ‡] [+ è¡¥å……è¡€ç¼˜]
```

## æŠ€æœ¯å®ç°è¦ç‚¹

### SQL è§£æç­–ç•¥

```python
# ä¼ªä»£ç ç¤ºä¾‹
def parse_insert_overwrite_sql(sql_content):
    # 1. æå–ç›®æ ‡è¡¨
    target_table = re.search(r'INSERT OVERWRITE TABLE\s+(\S+)', sql_content, re.I)

    # 2. æå–æºè¡¨ï¼ˆFROM + JOINï¼‰
    from_clause = re.search(r'FROM\s+(\S+)', sql_content, re.I)
    join_clauses = re.findall(r'(LEFT|RIGHT|INNER|FULL)?\s*JOIN\s+(\S+)\s+ON\s+([^WHERE|GROUP|ORDER]+)', sql_content, re.I)

    # 3. æå– SELECT åˆ—è¡¨
    select_clause = re.search(r'SELECT\s+(.*?)\s+FROM', sql_content, re.I | re.DOTALL)

    # 4. åˆ†ææ¯ä¸ªå­—æ®µçš„è¡€ç¼˜
    for field_expr in select_clause.split(','):
        # è¯†åˆ«åˆ«å
        alias = re.search(r'AS\s+(\w+)', field_expr, re.I)

        # è¯†åˆ«èšåˆå‡½æ•°
        if re.search(r'SUM\(', field_expr, re.I):
            transform_type = 'SUM'
        elif re.search(r'COUNT\(', field_expr, re.I):
            transform_type = 'COUNT'
        # ... å…¶ä»–ç±»å‹

    return {
        'target_table': target_table,
        'source_tables': [...],
        'column_lineage': [...],
        'indicators': [...]
    }
```

### æŒ‡æ ‡è¯†åˆ«è§„åˆ™

| æ¨¡å¼                          | è¯†åˆ«ä¸º          | standard_type |
|-------------------------------|----------------|---------------|
| `SUM(xxx_amt)`               | èšåˆæŒ‡æ ‡        | æ•°å€¼ç±»         |
| `COUNT(DISTINCT xxx_id)`     | å»é‡è®¡æ•°æŒ‡æ ‡     | æ•°å€¼ç±»         |
| `SUM(CASE WHEN ... 1 ELSE 0)`| æ¡ä»¶è®¡æ•°æŒ‡æ ‡     | æ•°å€¼ç±»         |
| `A / NULLIF(B, 0)`           | æ¯”ç‡ç±»æ´¾ç”ŸæŒ‡æ ‡   | æ•°å€¼ç±»         |
| `ROW_NUMBER() OVER (...)`    | æ’åç±»æŒ‡æ ‡ï¼ˆä¸å…¥åº“ï¼‰| -           |
| `DATE/TIMESTAMP å­—æ®µ`         | æ—¥æœŸæŒ‡æ ‡        | æ—¥æœŸç±»/æ—¶é—´ç±»   |
| `CASE WHEN â†’ æœ‰é™æšä¸¾å€¼`      | æšä¸¾æŒ‡æ ‡        | æšä¸¾ç±»         |
| `VARCHAR/STRING æ–‡æœ¬è¾“å‡º`      | æ–‡æœ¬æŒ‡æ ‡        | æ–‡æœ¬ç±»         |

### MCP å·¥å…·æ˜ å°„

| åˆ†æé˜¶æ®µ         | MCP å·¥å…·                   | ç”¨é€”                          |
|-----------------|----------------------------|------------------------------|
| Phase 2         | `get_table_detail`         | è·å–ç›®æ ‡è¡¨ç°æœ‰å­—æ®µåˆ—è¡¨        |
| Phase 3         | `search_existing_indicators`| æ£€æŸ¥æŒ‡æ ‡æ˜¯å¦å·²æ³¨å†Œ           |
| Phase 5         | `register_lineage`         | æ‰¹é‡æ³¨å†Œè¡¨çº§å’Œå­—æ®µçº§è¡€ç¼˜      |
| Phase 5         | `register_indicator`       | æ‰¹é‡æ³¨å†Œæ–°è¯†åˆ«çš„æŒ‡æ ‡          |

## ä¸å…¶ä»– Skill çš„å…³ç³»

```
dw-requirement-triage    â”€â”€â†’  ç”Ÿæˆæ–°éœ€æ±‚çš„æŒ‡æ ‡å’Œè¡€ç¼˜ï¼ˆå‰å‘ï¼‰
                              â†‘ å¯å¯¹æ¯”å¤ç”¨æ£€æŸ¥
reverse-engineer-metadata â”€â”€â†’ ä»å­˜é‡ä»£ç æå–æŒ‡æ ‡å’Œè¡€ç¼˜ï¼ˆé€†å‘ï¼‰
                              â†‘ è¡¥é½å…ƒæ•°æ®ç¼ºå£
```

**äº’è¡¥åœºæ™¯**:
- æ–°é¡¹ç›®å¯åŠ¨ï¼š`dw-requirement-triage` + `generate-standard-ddl` + `generate-etl-sql`
- é—ç•™ç³»ç»Ÿæ¥æ‰‹ï¼š`reverse-engineer-metadata` æ‰¹é‡ç›˜ç‚¹ â†’ ç„¶åç”¨ `review-sql` å®¡æŸ¥è§„èŒƒæ€§

## æ³¨æ„äº‹é¡¹

1. **SQL æ–¹è¨€å·®å¼‚**
   - Hive: æ”¯æŒ `INSERT OVERWRITE TABLE ... PARTITION (...)`
   - Impala: æ”¯æŒ `INSERT INTO ... SELECT`
   - Doris: æ”¯æŒ `INSERT INTO ... VALUES` å’Œ Stream Load
   - éœ€è¦è¯†åˆ«å¼•æ“ç±»å‹ï¼ˆæ ¹æ®æ–‡ä»¶è·¯å¾„æˆ– SQL ç‰¹å¾ï¼‰

2. **å¤æ‚ SQL å¤„ç†**
   - å¤šå±‚åµŒå¥—å­æŸ¥è¯¢ï¼šé€’å½’è§£æ
   - WITH å­å¥ï¼ˆCTEï¼‰ï¼šå…ˆå±•å¼€å†åˆ†æ
   - åŠ¨æ€ SQLï¼ˆå˜é‡æ›¿æ¢ï¼‰ï¼šæç¤ºç”¨æˆ·æ‰‹åŠ¨è¡¥å……

3. **å­—æ®µçº§è¡€ç¼˜ç²¾åº¦**
   - `SELECT *` åœºæ™¯ï¼šè°ƒç”¨ `list_columns` è·å–å®Œæ•´å­—æ®µåˆ—è¡¨
   - å¤æ‚è¡¨è¾¾å¼ï¼šè®°å½•ä¸º `CUSTOM` ç±»å‹ï¼Œä¿ç•™åŸå§‹ SQL è¡¨è¾¾å¼

4. **æŒ‡æ ‡å»é‡**
   - è°ƒç”¨ `search_existing_indicators` æ£€æŸ¥æ˜¯å¦å·²æ³¨å†Œ
   - å¦‚æœå­˜åœ¨åŒåæŒ‡æ ‡ï¼Œå±•ç¤ºå·®å¼‚è®©ç”¨æˆ·å†³å®šæ˜¯å¦è¦†ç›–

## è¾“å‡ºæ–‡ä»¶

æ‰§è¡Œå®Œæˆåç”Ÿæˆï¼š
- `analysis_results/<target_table>_lineage.json` - è¡€ç¼˜å…³ç³» JSON
- `analysis_results/<target_table>_indicators.json` - æŒ‡æ ‡æ¸…å• JSON
- `analysis_results/registration_log.txt` - å…¥åº“æ—¥å¿—

## ç¤ºä¾‹è°ƒç”¨

```bash
# åœºæ™¯ 1: åˆ†æå•ä¸ªè„šæœ¬
/reverse-engineer-metadata sql/hive/etl/dm_loan_daily.sql

# åœºæ™¯ 2: æ‰¹é‡åˆ†æ dm å±‚æ‰€æœ‰è¡¨
/reverse-engineer-metadata --scan sql/hive/etl/ --filter "dm_*.sql"

# åœºæ™¯ 3: ä»…ç”Ÿæˆåˆ†ææŠ¥å‘Šä¸å…¥åº“
/reverse-engineer-metadata --scan sql/hive/etl/ --dry-run

# åœºæ™¯ 4: ä»…æå–è¡€ç¼˜ï¼ˆæ€§èƒ½ä¼˜åŒ–åœºæ™¯ï¼‰
/reverse-engineer-metadata sql/hive/etl/dm_loan_daily.sql --skip-indicators
```

## æ‰©å±•èƒ½åŠ›

æœªæ¥å¯å¢å¼ºï¼š
- [ ] æ”¯æŒ Python/Spark SQL è„šæœ¬è§£æ
- [ ] ä¸ Git å†å²é›†æˆï¼Œè¿½è¸ªå­—æ®µå˜æ›´å†å²
- [ ] ç”Ÿæˆ Mermaid è¡€ç¼˜å›¾å¯è§†åŒ–
- [ ] ä¸è°ƒåº¦ç³»ç»Ÿé›†æˆï¼Œè‡ªåŠ¨æ£€æµ‹æ–°å¢è„šæœ¬

---

**Created by**: Claude Code
**Version**: 1.0
**Last Updated**: 2026-02-08
