# å­—æ®µå¯¹é½æœºåˆ¶ - Field Alignment

## é—®é¢˜èƒŒæ™¯

DML è„šæœ¬ä¸­çš„ `SELECT` åˆ«åä¸ä¸€å®šç­‰äºç›®æ ‡è¡¨çš„å®é™…å­—æ®µåï¼š

```sql
INSERT OVERWRITE TABLE dm.dmm_loan_daily PARTITION (dt='2024-01-01')
SELECT
    a.stat_date AS report_date,        -- ç›®æ ‡è¡¨å®é™…å­—æ®µ: dt
    SUM(loan_amt) AS total_amount,     -- ç›®æ ‡è¡¨å®é™…å­—æ®µ: td_loan_amt
    COUNT(1) AS cnt                    -- ç›®æ ‡è¡¨å®é™…å­—æ®µ: td_loan_cnt
FROM dwd.dwd_loan_detail a
```

### é£é™©

å¦‚æœç›´æ¥ä½¿ç”¨ SQL ä¸­çš„åˆ«åï¼ˆ`report_date`, `total_amount`, `cnt`ï¼‰ï¼š

1. âŒ **æŒ‡æ ‡æ³¨å†Œé”™è¯¯**: æ³¨å†Œäº†ä¸å­˜åœ¨çš„å­—æ®µå
2. âŒ **è¡€ç¼˜æ˜ å°„é”™è¯¯**: æ— æ³•è¿½è¸ªçœŸå®å­—æ®µçš„æ•°æ®æ¥æº
3. âŒ **å…³è”å¤±è´¥**: æ— æ³•ä¸å·²æœ‰æŒ‡æ ‡å…³è”

---

## è§£å†³æ–¹æ¡ˆï¼šä½ç½®å¯¹é½ + å…ƒæ•°æ®æ ¡éªŒ

### æ ¸å¿ƒåŸç†

**Hive INSERT OVERWRITE é»˜è®¤æŒ‰ä½ç½®å¯¹åº”**ï¼š

```
SELECT ç¬¬ 1 ä¸ªå­—æ®µ â†’ ç›®æ ‡è¡¨ç¬¬ 1 ä¸ªå­—æ®µ
SELECT ç¬¬ 2 ä¸ªå­—æ®µ â†’ ç›®æ ‡è¡¨ç¬¬ 2 ä¸ªå­—æ®µ
...
```

### å®ç°æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: è§£æ SQL           â”‚
â”‚ - æå–ç›®æ ‡è¡¨å              â”‚
â”‚ - æå– SELECT åˆ—è¡¨          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: æŸ¥è¯¢å…ƒæ•°æ®          â”‚
â”‚ - è°ƒç”¨ list_columns(table) â”‚
â”‚ - è·å–çœŸå®å­—æ®µåˆ—è¡¨          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: ä½ç½®å¯¹é½            â”‚
â”‚ - æ¯”å¯¹å­—æ®µæ•°é‡              â”‚
â”‚ - æŒ‰ä½ç½®æ˜ å°„å­—æ®µå          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: æ›¿æ¢å­—æ®µå          â”‚
â”‚ - report_date â†’ dt         â”‚
â”‚ - total_amount â†’ td_loan_amtâ”‚
â”‚ - cnt â†’ td_loan_cnt        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä»£ç å®ç°

### 1. åˆå§‹åŒ–æ—¶ä¼ å…¥ MCP å®¢æˆ·ç«¯

```python
parser = SQLParser(
    sql_content=sql_text,
    sql_file='dm_loan_daily.sql',
    mcp_client=mcp_client  # âœ¨ ä¼ å…¥ MCP å®¢æˆ·ç«¯
)
```

### 2. è§£ææµç¨‹ä¸­è‡ªåŠ¨æŸ¥è¯¢å…ƒæ•°æ®

```python
def parse(self) -> SQLAnalysisResult:
    self._extract_target_table()
    self._fetch_target_columns_from_metadata()  # âœ¨ æŸ¥è¯¢å…ƒæ•°æ®
    self._extract_table_lineage()
    self._extract_column_lineage()
    self._align_columns_with_metadata()  # âœ¨ å­—æ®µå¯¹é½
    self._identify_indicators()
    self._generate_summary()
    return self.result
```

### 3. å…ƒæ•°æ®æŸ¥è¯¢

```python
def _fetch_target_columns_from_metadata(self):
    """æŸ¥è¯¢ç›®æ ‡è¡¨çš„çœŸå®å­—æ®µåˆ—è¡¨"""
    if not self.mcp_client or not self.result.target_table:
        return

    try:
        # è°ƒç”¨ MCP å·¥å…·
        columns_result = self.mcp_client.list_columns(self.result.target_table)
        if columns_result and 'columns' in columns_result:
            self.target_columns_from_metadata = [
                col['column_name'] for col in columns_result['columns']
                if col['column_name'] not in ('dt', 'create_time', 'update_time')
            ]
    except Exception as e:
        print(f"âš ï¸ å…ƒæ•°æ®æŸ¥è¯¢å¤±è´¥: {e}")
        # ä¸ä¸­æ–­è§£ææµç¨‹
```

### 4. ä½ç½®å¯¹é½

```python
def _align_columns_with_metadata(self):
    """å­—æ®µå¯¹é½ï¼šSELECT åˆ«å â†’ ç›®æ ‡è¡¨çœŸå®å­—æ®µå"""
    if not self.target_columns_from_metadata:
        return

    sql_columns = [cl.target_column for cl in self.result.column_lineage]

    # æ£€æŸ¥æ•°é‡
    if len(sql_columns) != len(self.target_columns_from_metadata):
        print(f"âš ï¸ å­—æ®µæ•°é‡ä¸åŒ¹é…: SQL {len(sql_columns)} vs è¡¨ {len(self.target_columns_from_metadata)}")
        return

    # æŒ‰ä½ç½®æ›¿æ¢
    for i, col_lineage in enumerate(self.result.column_lineage):
        real_column_name = self.target_columns_from_metadata[i]
        if col_lineage.target_column != real_column_name:
            print(f"   ğŸ”€ å­—æ®µå¯¹é½: {col_lineage.target_column} â†’ {real_column_name}")
            col_lineage.target_column = real_column_name
```

---

## æ•ˆæœæ¼”ç¤º

### è¾“å…¥ SQL

```sql
INSERT OVERWRITE TABLE dm.dmm_loan_daily PARTITION (dt='2024-01-01')
SELECT
    a.stat_date AS report_date,
    SUM(loan_amt) AS total_amount,
    COUNT(1) AS cnt
FROM dwd.dwd_loan_detail a
GROUP BY a.stat_date
```

### å…ƒæ•°æ®æŸ¥è¯¢ç»“æœ

```json
{
  "table_name": "dm.dmm_loan_daily",
  "columns": [
    {"column_name": "dt", "data_type": "STRING"},
    {"column_name": "td_loan_amt", "data_type": "DECIMAL(20,2)"},
    {"column_name": "td_loan_cnt", "data_type": "BIGINT"}
  ]
}
```

### å­—æ®µå¯¹é½æ—¥å¿—

```
ğŸ”€ å­—æ®µå¯¹é½: report_date â†’ dt
ğŸ”€ å­—æ®µå¯¹é½: total_amount â†’ td_loan_amt
ğŸ”€ å­—æ®µå¯¹é½: cnt â†’ td_loan_cnt
```

### æœ€ç»ˆè¾“å‡º

```json
{
  "column_lineage": [
    {
      "target_column": "dt",  // âœ… å·²æ›¿æ¢ä¸ºçœŸå®å­—æ®µå
      "source_table": "dwd.dwd_loan_detail",
      "source_column": "stat_date",
      "transform_type": "DIRECT"
    },
    {
      "target_column": "td_loan_amt",  // âœ… å·²æ›¿æ¢
      "source_column": "loan_amt",
      "transform_type": "SUM"
    },
    {
      "target_column": "td_loan_cnt",  // âœ… å·²æ›¿æ¢
      "transform_type": "COUNT"
    }
  ]
}
```

---

## è¾¹ç•Œæƒ…å†µå¤„ç†

### æƒ…å†µ 1: å…ƒæ•°æ®æŸ¥è¯¢å¤±è´¥

**è¡Œä¸º**: ä¸ä¸­æ–­è§£ææµç¨‹ï¼Œä½¿ç”¨ SQL ä¸­çš„åˆ«å

```python
âš ï¸ å…ƒæ•°æ®æŸ¥è¯¢å¤±è´¥: Connection timeout
â„¹ï¸ å°†ä½¿ç”¨ SQL ä¸­çš„åˆ«åè¿›è¡Œè§£æ
```

### æƒ…å†µ 2: å­—æ®µæ•°é‡ä¸åŒ¹é…

**åœºæ™¯**: SQL SELECT 8 ä¸ªå­—æ®µï¼Œä½†ç›®æ ‡è¡¨åªæœ‰ 5 ä¸ªå­—æ®µ

**è¡Œä¸º**: å‘å‡ºè­¦å‘Šï¼Œä¸æ‰§è¡Œå¯¹é½

```python
âš ï¸ å­—æ®µæ•°é‡ä¸åŒ¹é…: SQL 8 vs ç›®æ ‡è¡¨ 5
   SQL å­—æ®µ: [report_date, total_amount, cnt, ...]
   ç›®æ ‡è¡¨å­—æ®µ: [dt, td_loan_amt, td_loan_cnt, product_id, product_name]
â„¹ï¸ è·³è¿‡å­—æ®µå¯¹é½ï¼Œä½¿ç”¨ SQL åˆ«å
```

**å¯èƒ½åŸå› **:
- SQL ä¸­æœ‰æ´¾ç”Ÿå­—æ®µæœªæŒä¹…åŒ–åˆ°è¡¨
- ç›®æ ‡è¡¨ç»“æ„å·²å˜æ›´ï¼ˆéœ€è¦ ALTER TABLEï¼‰
- SQL è§£æé”™è¯¯ï¼ˆå¦‚è¯¯è¯†åˆ«æ³¨é‡Šè¡Œï¼‰

### æƒ…å†µ 3: æ²¡æœ‰ä¼ å…¥ MCP å®¢æˆ·ç«¯

**è¡Œä¸º**: è·³è¿‡å…ƒæ•°æ®æŸ¥è¯¢ï¼Œç›´æ¥ä½¿ç”¨ SQL åˆ«å

```python
# ç¦»çº¿è§£ææ¨¡å¼
parser = SQLParser(sql_content=sql_text)  # æœªä¼ å…¥ mcp_client
result = parser.parse()

# ç»“æœ: ä½¿ç”¨ SQL ä¸­çš„åˆ«å
result.column_lineage[0].target_column  # â†’ "report_date"ï¼ˆåŸå§‹åˆ«åï¼‰
```

---

## ä½¿ç”¨å»ºè®®

### âœ… æ¨èåœºæ™¯

1. **ç”Ÿäº§ç¯å¢ƒåˆ†æ**: å…ƒæ•°æ®å‡†ç¡®ï¼Œå¿…é¡»å¯¹é½
2. **æ‰¹é‡ç›˜ç‚¹**: ç¡®ä¿æŒ‡æ ‡åç§°ä¸è¡¨ç»“æ„ä¸€è‡´
3. **è‡ªåŠ¨åŒ–å…¥åº“**: é¿å…æ³¨å†Œé”™è¯¯çš„å­—æ®µå

### âš ï¸ å¯é€‰åœºæ™¯

1. **æ–°è¡¨å¼€å‘**: ç›®æ ‡è¡¨è¿˜æœªåˆ›å»ºï¼Œå…ƒæ•°æ®ä¸å­˜åœ¨
2. **ç¦»çº¿åˆ†æ**: æ—  MCP è¿æ¥ï¼Œä»…åšä»£ç å®¡æŸ¥
3. **åŸå‹éªŒè¯**: å¿«é€Ÿæµ‹è¯• SQL è§£æèƒ½åŠ›

### é…ç½®æ–¹å¼

```python
# æ–¹å¼ 1: å¯ç”¨å…ƒæ•°æ®æ ¡éªŒï¼ˆæ¨èï¼‰
parser = SQLParser(
    sql_content=sql_text,
    mcp_client=mcp_client  # âœ… ä¼ å…¥å®¢æˆ·ç«¯
)

# æ–¹å¼ 2: ç¦ç”¨å…ƒæ•°æ®æ ¡éªŒï¼ˆç¦»çº¿æ¨¡å¼ï¼‰
parser = SQLParser(
    sql_content=sql_text,
    mcp_client=None  # âš ï¸ ä¸ä¼ å…¥å®¢æˆ·ç«¯
)
```

---

## æ€§èƒ½å½±å“

| æ“ä½œ                  | æ—¶é—´å¼€é”€      | ä¼˜åŒ–å»ºè®®                     |
|----------------------|--------------|------------------------------|
| å…ƒæ•°æ®æŸ¥è¯¢ (å•è¡¨)     | ~200ms       | å¯æ¥å—                       |
| æ‰¹é‡åˆ†æ (100 è¡¨)    | ~20s         | ä½¿ç”¨ç¼“å­˜ï¼ˆå¾…å®ç°ï¼‰            |
| ç¦»çº¿æ¨¡å¼ (æ—  MCP)    | 0ms          | é€‚ç”¨äºä»£ç å®¡æŸ¥                |

**ä¼˜åŒ–æ–¹å‘**:
- [ ] å¢åŠ å…ƒæ•°æ®ç¼“å­˜ï¼ˆé¿å…é‡å¤æŸ¥è¯¢åŒä¸€å¼ è¡¨ï¼‰
- [ ] æ‰¹é‡æŸ¥è¯¢æ¥å£ï¼ˆä¸€æ¬¡æŸ¥è¯¢å¤šå¼ è¡¨ï¼‰
- [ ] å¼‚æ­¥æŸ¥è¯¢ï¼ˆè§£æå’ŒæŸ¥è¯¢å¹¶è¡Œï¼‰

---

## ä¸å…¶ä»–åŠŸèƒ½çš„å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å­—æ®µå¯¹é½ï¼ˆæœ¬åŠŸèƒ½ï¼‰                      â”‚
â”‚  - ç¡®ä¿å­—æ®µåå‡†ç¡®                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æŒ‡æ ‡è¯†åˆ«                                â”‚
â”‚  - åŸºäºçœŸå®å­—æ®µåæ¨æ–­æŒ‡æ ‡                â”‚
â”‚  - ç¤ºä¾‹: td_loan_amt â†’ å½“æ—¥æ”¾æ¬¾é‡‘é¢      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æŒ‡æ ‡å»é‡æ£€æŸ¥                            â”‚
â”‚  - search_existing_indicators(td_loan_amt)â”‚
â”‚  - é¿å…é‡å¤æ³¨å†Œ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ‰¹é‡å…¥åº“                                â”‚
â”‚  - register_indicator(...)               â”‚
â”‚  - register_lineage(...)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‚¹**: å­—æ®µå¯¹é½æ˜¯åç»­æ‰€æœ‰æ“ä½œçš„åŸºç¡€ã€‚å¦‚æœå­—æ®µåé”™è¯¯ï¼Œä¼šå¯¼è‡´ï¼š
- æŒ‡æ ‡æ³¨å†Œåˆ°ä¸å­˜åœ¨çš„å­—æ®µ
- è¡€ç¼˜å…³ç³»è¿½è¸ªé”™è¯¯
- æ— æ³•ä¸ç°æœ‰æŒ‡æ ‡å…³è”

---

## FAQ

### Q1: å¦‚æœç›®æ ‡è¡¨ä¸å­˜åœ¨æ€ä¹ˆåŠï¼Ÿ

**A**: å…ƒæ•°æ®æŸ¥è¯¢ä¼šå¤±è´¥ï¼Œè‡ªåŠ¨å›é€€åˆ°ä½¿ç”¨ SQL åˆ«åã€‚é€‚ç”¨äºæ–°è¡¨å¼€å‘åœºæ™¯ã€‚

### Q2: å¦‚æœ SQL ä½¿ç”¨äº† `INSERT INTO table (col1, col2, ...)` æ˜¾å¼æŒ‡å®šåˆ—åï¼Ÿ

**A**: å½“å‰ç‰ˆæœ¬æš‚ä¸æ”¯æŒã€‚åç»­å¯å¢å¼ºä¸º**åç§°åŒ¹é…æ¨¡å¼**ï¼ˆä¼˜å…ˆçº§é«˜äºä½ç½®å¯¹é½ï¼‰ã€‚

### Q3: å¦‚ä½•éªŒè¯å¯¹é½æ˜¯å¦æ­£ç¡®ï¼Ÿ

**A**: æŸ¥çœ‹æ—¥å¿—è¾“å‡ºï¼š

```
ğŸ”€ å­—æ®µå¯¹é½: report_date â†’ dt
ğŸ”€ å­—æ®µå¯¹é½: total_amount â†’ td_loan_amt
```

å¦‚æœè¾“å‡ºä¸ºç©ºï¼Œè¯´æ˜ï¼š
- å…ƒæ•°æ®æŸ¥è¯¢å¤±è´¥ï¼Œæˆ–
- SQL åˆ«åä¸ç›®æ ‡è¡¨å­—æ®µåå®Œå…¨ä¸€è‡´ï¼ˆæ— éœ€å¯¹é½ï¼‰

### Q4: èƒ½å¦æ‰‹åŠ¨æŒ‡å®šå¯¹é½è§„åˆ™ï¼Ÿ

**A**: å½“å‰ç‰ˆæœ¬ä¸æ”¯æŒã€‚å¯ä»¥æ‰©å±•ä¸ºï¼š

```python
parser = SQLParser(
    sql_content=sql_text,
    mcp_client=mcp_client,
    custom_mapping={'report_date': 'dt', 'total_amount': 'td_loan_amt'}  # æ‰‹åŠ¨æ˜ å°„
)
```

---

**Created by**: Claude Code
**Version**: 1.0
**Last Updated**: 2026-02-08
