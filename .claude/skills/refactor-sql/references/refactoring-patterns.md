# Refactor SQL Patterns

## 目录

1. 使用方式与执行顺序
2. 代码结构模式（C01-C06）
3. 性能优化模式（P01-P06）
4. 合规修复映射（F-Dxx / F-Exx / F-Sxx）
5. 冲突处理与回滚建议

## 1. 使用方式与执行顺序

执行顺序固定为：

1. 合规修复（`F-*`）
2. 代码结构优化（`C*`）
3. 性能优化（`P*`）

规则冲突时优先级：

`FATAL 修复 > 等价性 > 性能收益 > 可读性`

---

## 2. 代码结构模式（C01-C06）

### C01: 深层嵌套拆解为 CTE

- 触发条件: 子查询嵌套深度 > 2
- 改写动作: 把每层子查询提取为具名 CTE
- 预期收益: 可读性提升、便于单段调试

```sql
-- before
SELECT * FROM (SELECT ... FROM (SELECT ... ) t1) t2;

-- after
WITH src AS (...),
agg AS (...)
SELECT ...
FROM agg;
```

### C02: 重复逻辑抽取

- 触发条件: 相同 CASE/表达式重复 >= 2 次
- 改写动作: 提前在 CTE 计算一次并复用
- 预期收益: 降低维护成本，避免口径漂移

### C03: 安全除法

- 触发条件: 存在 `a / b` 且 `b` 可能为 0
- 改写动作: `a / NULLIF(b, 0)`
- 预期收益: 避免运行时异常或错误结果

### C04: NULL 安全聚合

- 触发条件: SUM/AVG 输入字段可能为 NULL
- 改写动作: 聚合前或输出处补 `COALESCE`
- 预期收益: 防止指标空值传播

### C05: 语义化命名

- 触发条件: CTE/别名使用 `t1/t2/a/b`
- 改写动作: 改为业务语义命名（如 `loan_base`, `repay_agg`）
- 预期收益: 降低理解成本

### C06: `SELECT *` 显式化

- 触发条件: 存在 `SELECT *`
- 改写动作: 展开为明确字段列表
- 预期收益: 避免上游 Schema 漂移导致结果变化

---

## 3. 性能优化模式（P01-P06）

### P01: 分区过滤补全

- 触发条件: 事实表扫描无分区条件
- 改写动作: 添加 `stat_date`/`stat_month` 过滤
- 风险: 低（需确认业务日期口径）

### P02: JOIN 顺序优化

- 触发条件: 多表 JOIN 未按大小表顺序或主驱动表不清晰
- 改写动作: 主表先行，小表后关联，必要时改写为 EXISTS
- 风险: 中（可能影响执行计划）

### P03: 广播/MapJoin Hint

- 触发条件: 大表 + 小维表关联且小表可广播
- 改写动作:
  - Hive: `/*+ MAPJOIN(dim) */`
  - Impala: `/*+ BROADCAST(dim) */` 或 `[BROADCAST]`
- 风险: 中（需结合引擎资源）

### P04: 倾斜处理

- 触发条件: 热点 key 明显、聚合长尾严重
- 改写动作: 两阶段聚合 / 盐值打散 / 热点单独处理
- 风险: 中-高（逻辑复杂度增加）

### P05: 先聚合后关联

- 触发条件: 明细先 JOIN 再 GROUP BY
- 改写动作: 先在事实表聚合，再与维度表关联
- 风险: 中（需保证粒度不变）

### P06: 分区裁剪强化

- 触发条件: 过滤写法导致裁剪失效（函数包裹分区字段等）
- 改写动作: 改为原生分区字段比较，不在分区字段外包函数
- 风险: 低

---

## 4. 合规修复映射（F-Dxx / F-Exx / F-Sxx）

本节把 `review-sql` 规则映射为自动修复动作。修复时保持规则 ID 一致，便于审计。

### 4.1 DDL 规则映射（F-D01 ~ F-D08）

| 映射ID | 来源规则 | 自动修复动作 |
|--------|---------|-------------|
| F-D01 | D-01 表命名 | 标准化为 `{层}_{主题}_{粒度}`，保留原名注释 |
| F-D02 | D-02 字段词根 | 调整字段命名顺序或给出 rename 建议 |
| F-D03 | D-03 字段 COMMENT | 补齐缺失 COMMENT |
| F-D04 | D-04 表 COMMENT 粒度 | 在 COMMENT 追加 `[粒度:...]` |
| F-D05 | D-05 TBLPROPERTIES | 补 `logical_primary_key` 等关键属性 |
| F-D06 | D-06 分区字段命名 | 非标准分区字段改为 `stat_date/stat_month` |
| F-D07 | D-07 字段排序 | 调整为“维度->布尔->指标” |
| F-D08 | D-08 类型合理性 | 依据语义修正 DECIMAL/BIGINT/TINYINT 等 |

### 4.2 ETL 规则映射（F-E01 ~ F-E10）

| 映射ID | 来源规则 | 自动修复动作 |
|--------|---------|-------------|
| F-E01 | E-01 主表分区过滤 | 在主表 WHERE 补分区条件 |
| F-E02 | E-02 JOIN 分区过滤 | 为 JOIN 事实表补分区过滤 |
| F-E03 | E-03 N:N 风险 | 增加去重/预聚合或改写 JOIN 键 |
| F-E04 | E-04 分母为 0 | 改 `x/y` 为 `x/NULLIF(y,0)` |
| F-E05 | E-05 聚合 NULL | 聚合结果补 `COALESCE` |
| F-E06 | E-06 GROUP BY 一致性 | 补齐非聚合字段到 GROUP BY |
| F-E07 | E-07 窗口函数完整性 | 补 PARTITION BY/ORDER BY |
| F-E08 | E-08 日期参数化 | 硬编码日期改为 `${...}` |
| F-E09 | E-09 CTE 命名 | `t1/t2` 改业务语义命名 |
| F-E10 | E-10 引擎语法匹配 | 改为目标引擎可执行语法 |

### 4.3 通用规则映射（F-S01 ~ F-S04）

| 映射ID | 来源规则 | 自动修复动作 |
|--------|---------|-------------|
| F-S01 | S-01 头部注释 | 补齐脚本头信息 |
| F-S02 | S-02 分层范围 | 非 dm/da 场景标注风险并请求确认 |
| F-S03 | S-03 SELECT * | 展开显式字段列表 |
| F-S04 | S-04 GROUP BY 序号 | 改为字段名 GROUP BY |

---

## 5. 冲突处理与回滚建议

### 5.1 常见冲突

1. 性能优化与可读性冲突（如过度 CTE）
2. 合规修复与历史兼容冲突（字段 rename）
3. 迁移改写与结果一致性冲突（函数语义差异）

### 5.2 处理策略

1. 优先保证业务结果一致
2. 高风险改写只生成候选 diff，等待用户确认
3. 每个改写块附上规则 ID 便于定位回滚

### 5.3 回滚粒度

按规则 ID 回滚，不整体回滚：
- 示例: 仅撤销 `P02`（JOIN 顺序）但保留 `C05`（命名优化）

---

## 6. 引擎适配矩阵

各规则在不同引擎下的适用性和差异行为：

| 规则 | Hive (Tez) | Impala | Doris | 说明 |
|------|-----------|--------|-------|------|
| **C01** 嵌套→CTE | 支持 | 支持 | 支持 | 三引擎通用 |
| **C02** 重复逻辑提取 | 支持 | 支持 | 支持 | 三引擎通用 |
| **C03** 安全除法 | `NULLIF` | `NULLIF` | `NULLIF` | 三引擎通用 |
| **C04** NULL 安全聚合 | `COALESCE` | `COALESCE` | `COALESCE` | 三引擎通用 |
| **C05** 语义化命名 | 支持 | 支持 | 支持 | 三引擎通用 |
| **C06** SELECT * 显式化 | 支持 | 支持 | 支持 | 三引擎通用 |
| **P01** 分区过滤 | `stat_date` / `stat_month` | `stat_date` / `stat_month` | `partition_key` | Doris 分区字段不同 |
| **P02** JOIN 顺序 | 大表驱动 | 大表驱动 | 大表驱动 | 三引擎通用，执行计划差异由优化器处理 |
| **P03** 广播 Hint | `/*+ MAPJOIN(t) */` | `/*+ BROADCAST(t) */` 或 `[BROADCAST]` | 不支持 Hint | Doris 由优化器自动选择 |
| **P04** 倾斜处理 | 两阶段聚合 / 盐值打散 | 两阶段聚合 / 盐值打散 | Colocate Join | Doris 优先考虑 Colocate 分布 |
| **P05** 先聚合后关联 | 支持 | 支持 | 支持 | 三引擎通用 |
| **P06** 分区裁剪 | 避免函数包裹分区列 | 避免函数包裹分区列 | 避免函数包裹分区列 | 三引擎通用 |
| **F-E08** 日期参数化 | `${hivevar:stat_date}` | `${var:stat_date}` | 外部传参 | 变量语法不同 |
| **F-E10** 引擎语法匹配 | Hive 语法 | Impala 语法 | MySQL 兼容语法 | 按目标引擎适配 |
