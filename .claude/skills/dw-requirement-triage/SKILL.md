---
name: dw-requirement-triage
description: 从业务需求文档中识别并提取数据仓库开发相关内容。用于分析PRD/BRD文档，区分应用开发需求与数仓开发需求，输出结构化的数仓需求清单。使用场景：(1) 收到混合型需求文档需要拆分时 (2) 需要识别报表/统计/分析类需求时 (3) 需要确定数仓分层和引擎选择时 (4) 评估需求是否涉及数仓开发时
---

# 数仓需求拆解 (DW Requirement Triage)

从混合型业务需求文档中精准识别数据仓库开发范畴的内容，输出结构化的数仓需求清单。

## 工作流程

```
输入文档 → 结构化扫描 → 语义级过滤 → 埋点识别 → 分层/引擎建议 → 输出结构化需求
```

### Step 1: 结构化区域扫描

扫描文档目录或大标题，优先提取以下章节：
- "统计需求"、"报表需求"、"数据分析"
- "数据埋点"、"埋点设计"
- "非功能性需求-数据部分"
- "Dashboard"、"大屏"、"BI"

### Step 2: 语义级过滤

按段落进行 OLTP vs OLAP 特征识别：

| 特征维度 | 应用开发 (排除) | 数仓开发 (保留) |
|---------|----------------|----------------|
| **关键词** | 录入、修改、点击、跳转、校验、弹窗 | 统计、分析、汇总、监控、下钻、趋势、环比、同比 |
| **时间维度** | 实时、当前状态 | 历史快照、T+1、周期性（每日/每月） |
| **数据形态** | 单条记录、事务性、明细操作 | 聚合数据、指标、维度 |
| **输出形式** | 页面跳转、弹窗、API响应、列表/表单 | 报表、图表、大屏、Excel导出 |

### Step 3: 埋点需求识别

埋点是数仓 ODS 层的重要数据源。识别并标记：
- 用户行为事件（点击、浏览、停留时长）
- 业务事件（下单、支付、退款）
- 系统事件（错误日志、性能指标）

### Step 4: 分层与引擎建议

根据需求特征建议数仓分层和查询引擎：

**数仓分层判断：**
- `ODS`：原始数据接入（埋点、业务库同步）
- `DWD`：明细数据清洗（字段标准化、数据质量）
- `DWS`：汇总数据（预聚合指标）
- `ADS`：应用数据（直接支撑报表/接口）

**引擎选择建议：**
- **Hive (Tez)**：大批量历史数据处理、复杂ETL、T+1报表
- **Impala**：交互式查询、即席分析、秒级响应
- **Doris**：实时分析、高并发查询、实时大屏

**Doris 表模型选择：**
- **Aggregate Model**：预聚合指标（SUM/MAX/MIN/COUNT）
- **Unique Model**：需要 Upsert 语义的维度表
- **Duplicate Model**：明细日志、全量保留

### Step 5: 元数据补全 (可选)

当配置了 `search-hive-metadata` MCP Server 时，自动调用元数据搜索服务补全需求：

**补全流程**:
```
提取的业务术语（如"放款金额"）
        ↓
search_by_comment(term="放款金额")
        ↓
找到匹配: dwd.dwd_loan_detail.loan_amount
        ↓
补全到需求的"数据来源"和"相关字段"
```

**可用的 MCP 工具**:
- `search_table`: 按表名搜索
- `search_by_comment`: 按业务术语搜索
- `get_table_detail`: 获取表详情
- `list_columns`: 获取字段列表

**补全规则**:
1. 对每个需求中的指标/维度，调用 `search_by_comment` 查找对应字段
2. 搜索结果唯一时，直接补全
3. 搜索结果不唯一时，触发交互式选择
4. 搜索无结果时，标记为"待确认数据来源"

### Step 6: 数据粒度识别

在进行建模决策前，必须明确表的数据粒度。粒度决定了是否可以复用现有表。

**粒度获取优先级**:
```
1. 优先从 TBLPROPERTIES 获取
   SHOW TBLPROPERTIES table_name('granularity')
        ↓
   若返回为空或无此属性
        ↓
2. 从表注释 (table_comment) 中解析
   约定格式: [粒度：字段1，字段2，...]
   示例: [粒度：申请号，统计日期]
        ↓
   使用正则提取: \[粒度[：:]\s*([^\]]+)\]
        ↓
3. 若仍无法获取，标记为"粒度待确认"
```

**粒度解析示例**:
```
表注释: "贷款申请明细表，记录每笔申请的详细信息 [粒度：申请号，统计日期]"
        ↓
解析结果: ["申请号", "统计日期"]
        ↓
用于建模决策: 判断新需求的 Group By Keys 是否与现有表粒度匹配
```

**粒度匹配决策**:
- **粒度完全匹配**: 可复用现有表，建议 `ALTER TABLE ADD COLUMN`
- **粒度更细**: 需要新建表（如现有表是日粒度，需求是小时粒度）
- **粒度更粗**: 可从现有表聚合得到（如现有表是申请粒度，需求是客户粒度）
- **粒度无法确定**: 询问用户确认或联系表负责人

## 输出格式

使用以下结构化模板输出提取的数仓需求：

```markdown
# 数仓需求清单

## 概览
- **文档名称**: [原文档名]
- **提取时间**: [日期]
- **需求数量**: [N] 项

## 需求列表

### 1. [需求名称]
- **原文描述**: [保持原文，不修改业务逻辑]
- **需求类型**: [聚合统计 | 明细查询 | 数据导出 | 实时监控 | 埋点接入]
- **涉及指标**: [指标1, 指标2, ...]
- **涉及维度**: [维度1, 维度2, ...]
- **时间粒度**: [实时 | 小时 | 日 | 周 | 月]
- **建议分层**: [ODS | DWD | DWS | ADS]
- **建议引擎**: [Hive | Impala | Doris]
- **数据来源**: [由 search-hive-metadata 补全，如 dwd.dwd_order_detail]
- **相关字段**: [由 search-hive-metadata 补全，如 order_amount(订单金额), order_id(订单ID)]
- **优先级评估**: [高 | 中 | 低]
- **备注**: [特殊说明或依赖关系]

### 2. [需求名称]
...

## 待确认项
[列出需要与业务方确认的模糊需求]

## 非数仓需求摘要
[简要说明被排除的应用开发内容，便于交接]
```

## 示例

**输入文档片段：**

> 用户在"我的订单"页面点击"申请退款"按钮，系统需校验订单是否超过7天，若未超过，弹出填写退款原因的弹窗。退款原因支持下拉选择，包括"质量问题"、"拍错"等。
>
> 管理后台需增加"退款分析"模块，展示每日各原因的退款单量分布，以及退款金额的周环比趋势。
>
> 运营人员需要导出过去一年的退款明细 Excel，包含用户ID、退款时间和原因。
>
> 用户点击退款按钮时需要埋点，记录用户ID、订单ID、点击时间。

**输出：**

```markdown
# 数仓需求清单

## 概览
- **文档名称**: 退款功能需求文档
- **提取时间**: 2024-01-15
- **需求数量**: 3 项

## 需求列表

### 1. 退款分析报表
- **原文描述**: 管理后台需增加"退款分析"模块，展示每日各原因的退款单量分布，以及退款金额的周环比趋势
- **需求类型**: 聚合统计
- **涉及指标**: 退款单量, 退款金额, 周环比
- **涉及维度**: 日期, 退款原因
- **时间粒度**: 日
- **建议分层**: ADS
- **建议引擎**: Impala (交互式查询) 或 Doris (如需实时)
- **优先级评估**: 高
- **备注**: 需要 DWS 层预聚合退款汇总表

### 2. 退款明细导出
- **原文描述**: 运营人员需要导出过去一年的退款明细Excel，包含用户ID、退款时间和原因
- **需求类型**: 明细查询
- **涉及指标**: 无（明细导出）
- **涉及维度**: 用户ID, 退款时间, 退款原因
- **时间粒度**: 年
- **建议分层**: DWD
- **建议引擎**: Hive (大数据量导出)
- **优先级评估**: 中
- **备注**: 一年数据量较大，建议分批导出

### 3. 退款按钮点击埋点
- **原文描述**: 用户点击退款按钮时需要埋点，记录用户ID、订单ID、点击时间
- **需求类型**: 埋点接入
- **涉及指标**: 点击次数
- **涉及维度**: 用户ID, 订单ID, 点击时间
- **时间粒度**: 实时
- **建议分层**: ODS
- **建议引擎**: Doris (实时写入)
- **优先级评估**: 高
- **备注**: 前端埋点，数仓负责接收和存储

## 待确认项
- 退款分析报表是否需要实时刷新？（影响引擎选择）
- 明细导出是否有权限控制要求？

## 非数仓需求摘要
- 退款按钮交互、弹窗逻辑（前端）
- 7天校验逻辑（后端）
- 退款原因下拉字典（后端/配置）
```

## 交互式确认

遇到以下情况时，主动询问用户确认：

1. **边界模糊**: "检测到'用户列表展示累计消费金额'，这可能是后端实时计算，也可能是数仓 T+1 计算。请确认是否需要数仓开发？"

2. **时效性不明**: "需求未明确时效性要求。'订单统计'是需要实时更新还是 T+1 即可？"

3. **数据源不明**: "需求涉及'用户活跃度'指标，但未说明数据来源。是基于埋点数据还是业务库数据？"

## References

详细的识别规则和引擎对比参见：
- [references/identification-rules.md](references/identification-rules.md) - 完整的 OLTP vs OLAP 识别规则
- [references/engine-comparison.md](references/engine-comparison.md) - Hive/Impala/Doris 引擎选择指南
