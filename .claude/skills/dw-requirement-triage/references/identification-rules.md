# 数仓需求识别规则详解

## 关键词特征库

### 数仓开发关键词 (保留)

**统计类**
- 统计、汇总、合计、总计、累计
- 平均、均值、中位数
- 最大、最小、峰值
- 占比、比例、分布

**分析类**
- 分析、趋势、走势
- 同比、环比、增长率、增幅
- 对比、比较、排名、Top N
- 下钻、上卷、切片

**报表类**
- 报表、报告、Dashboard、大屏
- 图表、折线图、柱状图、饼图
- 导出、Excel、CSV

**时间相关**
- 每日、每周、每月、每年
- T+1、历史、快照
- 过去N天、近N月
- 周期性、定时

**数据层面**
- 指标、度量、KPI
- 维度、粒度
- 明细、汇总、聚合

### 应用开发关键词 (排除)

**交互类**
- 点击、双击、长按、滑动
- 跳转、返回、刷新
- 弹窗、浮层、提示、Toast
- 展开、收起、折叠

**表单类**
- 输入、填写、选择
- 提交、保存、取消
- 校验、验证、必填
- 上传、下载（文件）

**UI类**
- 颜色、字体、大小
- 布局、样式、动画
- 响应式、自适应

**实时事务类**
- 新增、修改、删除（单条）
- 审批、审核（流程）
- 通知、推送、消息

## 复合判断规则

### 规则1: 时间维度判断
```
IF 涉及"历史数据" OR "周期性统计" OR "T+1"
THEN 数仓需求
ELSE IF 仅涉及"当前状态" OR "实时单条"
THEN 应用需求
```

### 规则2: 数据量判断
```
IF 涉及"大量数据导出" OR "全量统计" OR "跨月/年数据"
THEN 数仓需求
ELSE IF 仅涉及"单条记录" OR "分页列表"
THEN 应用需求
```

### 规则3: 计算复杂度判断
```
IF 涉及"同比环比" OR "复杂聚合" OR "多表关联统计"
THEN 数仓需求
ELSE IF 仅涉及"简单查询" OR "单表操作"
THEN 应用需求（可能）
```

### 规则4: 输出形式判断
```
IF 输出为"报表" OR "图表" OR "Excel批量导出"
THEN 数仓需求
ELSE IF 输出为"页面展示" OR "API响应" OR "表单"
THEN 应用需求（需进一步判断）
```

## 灰色地带处理

以下场景需要特别注意，可能需要与业务方确认：

### 1. 列表页统计
**场景**: "订单列表页显示总金额"
- 如果是当前筛选条件下的求和 → 后端实时计算
- 如果是全量历史统计 → 数仓计算

### 2. 用户画像
**场景**: "用户详情页展示累计消费"
- 如果需要实时准确 → 后端计算
- 如果允许 T+1 延迟 → 数仓计算更高效

### 3. 排行榜
**场景**: "商品销量排行"
- 实时排行 → 后端 + 缓存
- 日/周/月排行 → 数仓计算

### 4. 搜索统计
**场景**: "搜索热词统计"
- 实时热词 → Doris 实时聚合
- 历史趋势 → Hive 批量计算

## 埋点需求识别

### 前端埋点 (数仓需接收)
- 页面浏览 (PV/UV)
- 按钮点击
- 停留时长
- 滚动深度
- 曝光事件

### 业务埋点 (可能已在业务库)
- 订单创建
- 支付完成
- 用户注册

### 系统埋点 (运维相关)
- 错误日志
- 性能指标
- 接口耗时

## 交互图视觉识别规则

当输入包含交互图（原型图/Wireframe/Mockup）时，使用以下规则从视觉元素中识别数仓需求。

### 页面类型判断

```
交互图
│
├─ 报表页/Dashboard/大屏
│  → 高概率数仓需求，全面提取
│
├─ 列表页（含筛选+表格）
│  → 关注：筛选器维度、表格列头指标、合计行、导出按钮
│
├─ 详情页
│  → 关注：统计卡片区域（如"累计放款"、"历史逾期次数"）
│
├─ 表单页
│  → 通常非数仓需求，但注意下拉选项是否来自维度表
│
└─ 流程图/状态图
   → 关注：是否有统计节点（如"生成日报"、"更新指标"）
```

### UI 元素 → 数仓需求映射

| UI 元素 | 视觉特征 | 映射为 | 示例 |
|---------|---------|-------|------|
| **筛选器/下拉框** | 页面顶部或侧边的选择控件 | 维度 | 日期选择器→`stat_date`；渠道下拉→`channel` |
| **表格列头** | 带数字格式的列标题 | 指标（数值列）或维度（文本列） | "放款金额(万)" → 指标；"产品名称" → 维度 |
| **图表 X 轴** | 横轴标签 | 时间维度或分类维度 | "2024-01~12" → 月粒度；"华东/华南/华北" → 区域维度 |
| **图表 Y 轴** | 纵轴标签 | 指标 | "逾期率(%)" → 指标 `overdue_rate` |
| **数字卡片/KPI** | 大字号数字 + 标签 | 核心指标 | "今日放款 ¥1,234万" → `loan_amount` |
| **环比/同比标注** | 数字旁的箭头(↑↓)+百分比 | 衍生指标 | "↑12.3%" → 需计算环比 |
| **Tab/切换器** | 顶部标签切换 | 多粒度需求 | "按日｜按月" → 日/月双粒度 |
| **导出按钮** | "导出"/"下载 Excel" 按钮 | 数据导出需求 | 导出 → 需确认导出字段和数据量 |
| **下钻链接** | 可点击的文字/图标，箭头指向 | 层级关系 | "查看明细→" → 需要 DA 明细表 |
| **分页器** | "共 X 条，第 1/N 页" | 明细查询需求 | 大数据量分页 → 可能需要 Hive 导出 |
| **合计/小计行** | 表格底部或分组底部的汇总行 | 聚合计算需求 | "合计: ¥5,678万" → 需 SUM 聚合 |
| **图表类型** | 折线/柱状/饼图/散点图等 | 分析类型 | 折线→趋势；饼图→占比；柱状→对比 |

### 贷款业务常见交互图模式

以下是贷款业务场景中常见的交互图页面模式及其数仓需求映射：

| 页面模式 | 典型 UI 组成 | 数仓需求 |
|---------|------------|---------|
| **放款日报** | 日期筛选 + KPI卡片(放款金额/笔数) + 折线图 + 明细表 | dm 层日汇总表 |
| **逾期监控大屏** | 实时数字卡片 + 逾期率趋势图 + 区域地图 | Doris 实时表 + dm 汇总表 |
| **催收报表** | 多维筛选(日期/催收员/逾期天数) + 回收率表格 | da 层催收分析表 |
| **渠道分析** | 渠道下拉 + 对比柱状图 + 转化漏斗 | dm 层渠道指标宽表 |
| **客户画像** | 客户基本信息 + 历史借款统计区 + 风险评分 | dwm 客户宽表 (已有则复用) |

## Excel 导出模板识别规则

当输入包含 Excel 导出模板（.xlsx/.xls 文件或 Excel 截图）时，使用以下规则反推数仓需求。

### 模板类型判断

```
Excel 模板
│
├─ 明细导出模板
│  特征: 每行一条记录，无合计行，列数较多
│  → 确定导出字段清单和数据粒度
│
├─ 汇总报表模板
│  特征: 含合计/小计行，维度列+指标列分明
│  → 确定聚合维度、聚合方式(SUM/COUNT/AVG)
│
├─ 透视表模板
│  特征: 行维度+列维度交叉，值区域为指标
│  → 确定多维分析需求，可能需要 GROUPING SETS
│
└─ 混合模板（多 Sheet）
   特征: 不同 Sheet 承载不同维度视角或不同报表
   → 逐 Sheet 识别，可能对应多个数仓需求
```

### Excel 元素 → 数仓需求映射

| Excel 元素 | 识别方法 | 映射为 | 示例 |
|-----------|---------|-------|------|
| **列头（表头行）** | 第一行或冻结行的文本 | 维度(文本列) / 指标(数值列) | "产品名称"→维度；"放款金额(万)"→指标 |
| **数据格式** | 单元格格式设置 | 字段类型 | 百分比→`DECIMAL`；日期→`DATE`；整数→`BIGINT` |
| **公式** | 含 `=` 的单元格 | 衍生指标的计算逻辑 | `=C2/B2` → `overdue_amount / loan_amount` |
| **合计行** | "合计"/"总计" 文本行 | 全局聚合需求 | "合计: ¥5,678万" → 需 `SUM` 聚合 |
| **小计行** | 分组后的汇总行 | 分组聚合维度 | 按渠道小计 → `GROUP BY channel` |
| **冻结列** | 左侧冻结的列 | 维度列（通常是分析的固定维度） | 冻结"日期+渠道" → 核心维度 |
| **合并单元格** | 跨行/跨列合并 | 层级维度关系 | 一级分类合并3行 → 父子维度 |
| **条件格式** | 颜色/图标标记 | 业务阈值规则 | 红色>5% → 逾期率阈值告警 |
| **Sheet 名称** | 底部 Sheet Tab | 多维度视角/多报表 | "按日汇总""按月汇总" → 多粒度需求 |
| **数据行数** | 示例数据量 | 数据规模预估 | 100行日数据 × 365天 → ~36,500行/年 |
| **排序方式** | 数据已排序的列 | 默认排序需求 | 按日期降序 → Doris 排序键参考 |

### 贷款业务常见 Excel 导出模板模式

| 模板模式 | 典型列结构 | 数仓需求 |
|---------|-----------|---------|
| **放款明细导出** | 申请号、客户名、产品、渠道、放款金额、放款日期、利率 | dwd/dwm 层明细表，Hive 大批量导出 |
| **逾期台账** | 合同号、客户名、逾期天数区间、逾期金额、催收员、最近还款日 | da 层逾期报表，含维度分组小计 |
| **每日经营日报** | 日期、渠道、产品、进件量、授信量、放款量、放款金额、同比、环比 | dm 层日汇总表，含衍生指标计算 |
| **催收回收报表** | 催收批次、分配日期、催收员、分配金额、回收金额、回收率 | da 层催收分析，含公式计算回收率 |
| **渠道对比分析** | 渠道名、各月放款金额(列展开)、合计、占比 | dm 层渠道指标，透视表结构需 PIVOT 或 CASE WHEN |

### Excel 模板特有的口径线索

Excel 模板中的公式是确定指标口径的最可靠来源：

```
常见公式模式 → 口径判断:

=SUM(C2:C100)           → 简单求和，确认聚合方式为 SUM
=C2/B2                  → 比率指标，确认分子分母字段
=C2-D2                  → 差值指标，如 净放款 = 放款 - 退票
=(C2-D2)/D2             → 增长率，如 环比增长率
=SUMIF(A:A,"渠道A",C:C)  → 条件求和，暗示需要 WHERE 或 CASE WHEN
=VLOOKUP(A2,Sheet2!...) → 跨表关联，暗示需要 JOIN
```

## 需求分类决策树

```
需求输入 (文档 和/或 交互图 和/或 Excel模板)
│
├─ 是否有交互图?
│  ├─ 是 → 先执行交互图视觉解析
│  │      └─ 识别页面类型（报表/大屏 → 高概率数仓需求）
│  │      └─ 提取 UI 元素（筛选器→维度，表格列→指标，图表轴→粒度）
│  └─ 否 → 跳过
│
├─ 是否有 Excel 导出模板?
│  ├─ 是 → 执行 Excel 模板解析
│  │      └─ 识别模板类型（明细/汇总/透视/混合）
│  │      └─ 提取字段清单（列头→维度+指标，公式→口径，格式→类型）
│  │      └─ 提取聚合方式（合计行→SUM，小计行→GROUP BY维度）
│  └─ 否 → 跳过
│
├─ 是否有文本文档?
│  ├─ 是 → 执行文本语义分析
│  │      └─ 是否有明确的"报表/统计/分析"章节?
│  │         ├─ 是 → 直接提取该章节 (数仓需求)
│  │         └─ 否 → 继续逐段分析
│  └─ 否 → 跳过
│
├─ 多源同时存在? → 执行交叉验证
│  ├─ 多源一致 → 高确信度
│  ├─ 图/Excel有文无 → 补充需求，标注来源
│  ├─ 文有图/Excel无 → 保留，标注待确认
│  ├─ Excel公式与文本口径冲突 → 以Excel公式为准，标记待确认
│  └─ 其他冲突 → 标记待确认项
│
├─ 段落/UI元素是否包含数仓关键词?
│  ├─ 是 → 初步标记为数仓需求
│  │      └─ 检查是否有排除关键词混合
│  │         ├─ 有 → 拆分需求或标记待确认
│  │         └─ 无 → 确认为数仓需求
│  └─ 否 → 继续判断
│
├─ 是否涉及历史数据或周期性?
│  ├─ 是 → 可能是数仓需求，标记待确认
│  └─ 否 → 继续判断
│
├─ 是否涉及大量数据处理?
│  ├─ 是 → 可能是数仓需求，标记待确认
│  └─ 否 → 排除 (应用需求)
│
└─ 其他 → 排除 (应用需求)
```
